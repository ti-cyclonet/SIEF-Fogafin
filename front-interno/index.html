<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Acceso Interno - Gesti√≥n SIEF</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="./assets/styles-login.css"
    />
  </head>
  <body>
    <div class="login-container text-center">
      <div class="login-header mb-4">
        <img
          src="./assets/images/logo.svg"
          alt="Logo Fogaf√≠n"
          class="mb-3"
        />
        <h4>Aplicativo de Gesti√≥n Interna</h4>
      </div>

      <form id="loginForm">
        <div class="mb-3">
          <div class="input-group">
            <input
              type="text"
              class="form-control"
              placeholder="Usuario"
              id="inputUsuario"
              autocomplete="off"
              required
            />
            <button class="btn btn-outline-secondary" type="button" id="btnEditarUsuario" title="Editar usuario">
              <i class="fas fa-edit"></i>
            </button>
          </div>

        </div>


        <div class="mb-3 d-flex justify-content-start align-items-center">
          <input
            type="checkbox"
            class="form-check-input me-2"
            id="checkRobot"
            required
          />
          <label class="form-check-label me-3" for="checkRobot"
            >No soy un robot</label
          >
          <div class="ms-auto"><small>reCAPTCHA</small></div>
        </div>

        <button type="submit" class="btn btn-ingresar w-100 mt-2">
          <i class="fas fa-sign-in-alt me-2"></i> Ingresar
        </button>

        <a href="#" class="d-block mt-3 text-muted" style="font-size: 0.9em">
          ¬øHa olvidado su contrase√±a?
        </a>
        
        <button type="button" class="btn btn-sm btn-outline-info mt-2" onclick="testUserDetection()">
          üîç Test Usuario
        </button>
        <button type="button" class="btn btn-sm btn-outline-warning mt-2" onclick="detectRealUser()">
          üîÑ Detectar Usuario Real
        </button>
        <button type="button" class="btn btn-sm btn-outline-success mt-2" onclick="configureUser()">
          ‚öôÔ∏è Configurar Usuario
        </button>
        <div id="debugInfo" class="mt-2 small text-muted"></div>
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="./assets/js/windows-auth.js"></script>
    <script src="./assets/js/user-detector.js"></script>
    <script src="./config.js"></script>
    <script>
      // Utilidad para autenticaci√≥n de Windows
      class WindowsAuth {
        static async obtenerUsuarioWindows() {
          // Usar la nueva utilidad que funciona en local y nube
          const usuario = await WindowsAuthHelper.iniciarSesionAutomatica();
          
          // Fallback al backend si no se obtuvo usuario
          if (!usuario || usuario === 'adminSief') {
            try {
              // Obtener usuario detectado localmente
              const usuarioLocal = localStorage.getItem('detectedWindowsUser');
              let params = {};
              let headers = { 'Accept': 'text/plain' };
              
              // Si hay usuario local, enviarlo al backend
              if (usuarioLocal && usuarioLocal !== 'adminSief') {
                params.user = usuarioLocal;
                headers['X-User-Identity'] = usuarioLocal;
              }
              
              const url = getApiUrl('whoami', params);
              
              const response = await fetch(url, {
                method: 'GET',
                credentials: 'include',
                headers: headers
              });
              
              if (response.ok) {
                const usuarioBackend = await response.text();
                return usuarioBackend.trim();
              }
            } catch (error) {
              console.warn('Error obteniendo usuario desde backend:', error);
            }
          }
          
          return usuario;
        }

        static async intentarLoginAutomatico() {
          const usuario = await this.obtenerUsuarioWindows();
          if (usuario && usuario !== 'adminSief') {
            // Validar usuario antes de permitir login autom√°tico
            const validacion = await validarUsuarioResponsable(usuario);
            if (validacion && validacion.esValido) {
              // Si es v√°lido, guardar configuraci√≥n permanente
              localStorage.setItem('detectedWindowsUser', usuario);
              localStorage.setItem('userConfigured', 'true');
              return validacion;
            }
          }
          return null;
        }
      }
    </script>
    <script>
      // Variables de control
      let modoAutomatico = true;
      
      // Configuraci√≥n de API
      const isLocal = window.location.hostname === "localhost";
      const API_BASE_URL = isLocal
        ? "http://localhost:7176/api"
        : "https://rg-funciones-inscripcion-d0dpgpfrcmh8gxdg.eastus2-01.azurewebsites.net/api";
      
      // Usar funci√≥n del config.js
      
      // Obtener usuario del backend e intentar login autom√°tico
      document.addEventListener('DOMContentLoaded', async function() {
        try {
          // Auto-detectar usuario si no est√° configurado
          const yaConfigurado = localStorage.getItem('userConfigured') === 'true';
          if (!yaConfigurado) {
            await autoDetectAndConfigureUser();
          }
          
          // Ocultar botones de debug siempre
          const debugButtons = document.querySelectorAll('button[onclick*="test"], button[onclick*="detect"], button[onclick*="configure"]');
          debugButtons.forEach(btn => btn.style.display = 'none');
          
          // Verificar si se debe omitir login autom√°tico
          const params = new URLSearchParams(window.location.search);
          const omitirAuto = params.get('manual') === 'true' || localStorage.getItem('skipAutoLogin') === 'true';
          
          // Limpiar bandera de omitir login autom√°tico
          if (localStorage.getItem('skipAutoLogin')) {
            localStorage.removeItem('skipAutoLogin');
          }
          
          // Intentar login autom√°tico primero (si no est√° deshabilitado)
          const loginAutomatico = omitirAuto ? null : await WindowsAuth.intentarLoginAutomatico();
          
          if (loginAutomatico && loginAutomatico.esValido) {
            // Login autom√°tico exitoso
            const usuario = await WindowsAuth.obtenerUsuarioWindows();
            localStorage.setItem("currentUser", usuario);
            if (loginAutomatico.codigoArea) {
              localStorage.setItem("userArea", loginAutomatico.codigoArea);
              localStorage.setItem("userAreaName", loginAutomatico.nombreArea);
            }
            if (loginAutomatico.perfil) {
              localStorage.setItem("userPerfil", loginAutomatico.perfil);
            }
            
            // Redireccionar directamente al dashboard
            window.location.href = "pages/dashboard.html";
            return;
          }
          
          // Si no hay login autom√°tico, mostrar formulario con usuario obtenido
          const response = await fetch(getApiUrl('whoami'));
          if (response.ok) {
            const usuario = await response.text();
            const inputUsuario = document.getElementById('inputUsuario');
            inputUsuario.value = usuario.trim();
            inputUsuario.readOnly = true;
            inputUsuario.classList.add('text-muted');
            inputUsuario.style.backgroundColor = '#f8f9fa';
          }
        } catch (error) {
          // Silencioso - mostrar formulario normal
        }
        
        // Evento para alternar modo de edici√≥n
        document.getElementById('btnEditarUsuario').addEventListener('click', function() {
          const inputUsuario = document.getElementById('inputUsuario');
          const modoTexto = document.getElementById('modoUsuario');
          const btnIcon = this.querySelector('i');
          
          if (modoAutomatico) {
            // Cambiar a modo manual
            inputUsuario.readOnly = false;
            inputUsuario.classList.remove('text-muted');
            inputUsuario.style.backgroundColor = '';
            inputUsuario.focus();
            inputUsuario.select();

            btnIcon.className = 'fas fa-undo';
            this.title = 'Volver a modo autom√°tico';
            modoAutomatico = false;
          } else {
            // Volver a modo autom√°tico
            inputUsuario.readOnly = true;
            inputUsuario.classList.add('text-muted');
            inputUsuario.style.backgroundColor = '#f8f9fa';

            btnIcon.className = 'fas fa-edit';
            this.title = 'Editar usuario';
            modoAutomatico = true;
          }
        });
      });
      
      // Validaci√≥n de usuario en tabla TM04_Responsables
      async function validarUsuarioResponsable(usuario) {
        try {
          const response = await fetch(getApiUrl('validar-usuario'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ usuario: usuario })
          });
          
          if (response.ok) {
            const result = await response.json();
            return result;
          }
          return false;
        } catch (error) {
          console.error('Error validando usuario:', error);
          return false;
        }
      }

      document
        .getElementById("loginForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          const usuario = document.getElementById("inputUsuario").value;
          
          // Mostrar loading
          Swal.fire({
            title: "Validando usuario...",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
          });

          try {
            // Validar usuario en tabla TM04_Responsables
            const isAuthorized = await validarUsuarioResponsable(usuario);
            
            Swal.close();
            
            if (isAuthorized.esValido) {
              localStorage.setItem("currentUser", usuario);
              if (isAuthorized.codigoArea) {
                localStorage.setItem("userArea", isAuthorized.codigoArea);
                localStorage.setItem("userAreaName", isAuthorized.nombreArea);
                console.log(`Usuario ${usuario} pertenece al √°rea: ${isAuthorized.nombreArea} (C√≥digo: ${isAuthorized.codigoArea})`);
              }
              if (isAuthorized.perfil) {
                localStorage.setItem("userPerfil", isAuthorized.perfil);
                console.log(`Perfil del usuario: ${isAuthorized.perfil}`);
              }

              Swal.fire({
                title: "Acceso concedido",
                text: "Redirigiendo al Dashboard...",
                icon: "success",
                timer: 800,
                showConfirmButton: false,
                willClose: () => {
                  window.location.href = "pages/dashboard.html";
                },
              });
            } else {
              Swal.fire({
                icon: "error",
                title: "¬°Acceso Denegado!",
                html: "El usuario no est√° autorizado para acceder al sistema.",
                confirmButtonText: "Aceptar",
                confirmButtonColor: "#dc3545",
              });
            }
          } catch (error) {
            Swal.close();
            Swal.fire({
              icon: "error",
              title: "Error de conexi√≥n",
              text: "No se pudo validar el usuario. Intente nuevamente.",
              confirmButtonText: "Aceptar",
              confirmButtonColor: "#dc3545",
            });
          }
        });
        
        // Funci√≥n de prueba para debug
        async function testUserDetection() {
          const debugDiv = document.getElementById('debugInfo');
          
          // 1. Configurar usuario de prueba
          localStorage.setItem('detectedWindowsUser', 'jgarzon');
          
          // 2. Construir URL
          const params = { user: 'jgarzon' };
          const url = getApiUrl('whoami', params);
          
          debugDiv.innerHTML = `
            <strong>Debug Info:</strong><br>
            Usuario en localStorage: ${localStorage.getItem('detectedWindowsUser')}<br>
            URL generada: ${url}<br>
          `;
          
          // 3. Hacer llamada
          try {
            const response = await fetch(url, {
              method: 'GET',
              headers: { 'X-User-Identity': 'jgarzon' }
            });
            
            const usuario = await response.text();
            debugDiv.innerHTML += `Respuesta del backend: <strong>${usuario}</strong><br>`;
            
            if (usuario === 'jgarzon') {
              debugDiv.innerHTML += '<span style="color: green;">‚úÖ ¬°Funciona correctamente!</span>';
            } else {
              debugDiv.innerHTML += '<span style="color: red;">‚ùå A√∫n devuelve adminSief</span>';
            }
            
          } catch (error) {
            debugDiv.innerHTML += `Error: ${error.message}`;
          }
        }
        
        // Detectar usuario real del sistema
        async function detectRealUser() {
          const debugDiv = document.getElementById('debugInfo');
          
          // 1. Limpiar localStorage
          localStorage.removeItem('detectedWindowsUser');
          localStorage.removeItem('userPromptShown');
          
          debugDiv.innerHTML = 'Detectando usuario real del sistema...<br>';
          
          // 2. Intentar detectar usuario real
          const usuarioReal = await WindowsAuthHelper.obtenerUsuarioWindows();
          
          debugDiv.innerHTML += `Usuario detectado: <strong>${usuarioReal}</strong><br>`;
          
          // 3. Probar con el backend
          if (usuarioReal && usuarioReal !== 'adminSief') {
            const params = { user: usuarioReal };
            const url = getApiUrl('whoami', params);
            
            try {
              const response = await fetch(url, {
                method: 'GET',
                headers: { 'X-User-Identity': usuarioReal }
              });
              
              const usuarioBackend = await response.text();
              debugDiv.innerHTML += `Respuesta del backend: <strong>${usuarioBackend}</strong><br>`;
              
              // 4. Guardar permanentemente si funciona
              if (usuarioBackend === usuarioReal) {
                localStorage.setItem('detectedWindowsUser', usuarioReal);
                localStorage.setItem('userConfigured', 'true');
                debugDiv.innerHTML += '<span style="color: green;">‚úÖ Usuario guardado permanentemente</span><br>';
              }
              
              // 5. Actualizar campo de usuario
              const inputUsuario = document.getElementById('inputUsuario');
              if (inputUsuario) {
                inputUsuario.value = usuarioReal;
              }
              
            } catch (error) {
              debugDiv.innerHTML += `Error: ${error.message}`;
            }
          } else {
            debugDiv.innerHTML += '<span style="color: orange;">No se pudo detectar usuario autom√°ticamente</span>';
          }
        }
        
        // Configurar usuario manualmente
        function configureUser() {
          const currentUser = localStorage.getItem('detectedWindowsUser') || '';
          const newUser = prompt('Ingrese su usuario de Windows (ej: AlfredoMamby):', currentUser);
          
          if (newUser && newUser.trim()) {
            const cleanUser = newUser.trim().toLowerCase();
            localStorage.setItem('detectedWindowsUser', cleanUser);
            
            // Actualizar campo de usuario
            const inputUsuario = document.getElementById('inputUsuario');
            if (inputUsuario) {
              inputUsuario.value = cleanUser;
            }
            
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML = `<span style="color: green;">‚úÖ Usuario configurado: <strong>${cleanUser}</strong></span><br>`;
            debugDiv.innerHTML += 'La pr√≥xima vez se usar√° autom√°ticamente.';
          }
        }
        
        // Auto-detectar y configurar usuario autom√°ticamente
        async function autoDetectAndConfigureUser() {
          try {
            // Intentar obtener usuario desde el entorno del navegador
            let usuarioDetectado = null;
            
            // M√©todo 1: ActiveX (IE/Edge corporativo)
            try {
              if (typeof ActiveXObject !== 'undefined') {
                const network = new ActiveXObject("WScript.Network");
                usuarioDetectado = network.UserName;
              }
            } catch (e) {}
            
            // M√©todo 2: Desde variables del sistema (si est√°n disponibles)
            if (!usuarioDetectado && typeof process !== 'undefined' && process.env) {
              usuarioDetectado = process.env.USERNAME || process.env.USER;
            }
            
            // M√©todo 3: Prompt √∫nico y silencioso
            if (!usuarioDetectado) {
              const hostname = window.location.hostname;
              const isLocal = hostname === 'localhost' || hostname.includes('.local');
              
              if (!isLocal) {
                // En nube, usar prompt una sola vez
                usuarioDetectado = prompt('Para configuraci√≥n inicial, ingrese su usuario de Windows:');
              }
            }
            
            // Si se detect√≥ usuario, validarlo con el backend
            if (usuarioDetectado && usuarioDetectado.trim()) {
              const cleanUser = usuarioDetectado.trim().toLowerCase();
              
              // Validar usuario en sistemas comunes y SIEF
              const isValid = await validarUsuarioResponsable(cleanUser);
              
              if (isValid && isValid.esValido) {
                // Usuario v√°lido - guardar permanentemente
                localStorage.setItem('detectedWindowsUser', cleanUser);
                localStorage.setItem('userConfigured', 'true');
                
                // Guardar informaci√≥n adicional del usuario
                if (isValid.codigoArea) {
                  localStorage.setItem('userArea', isValid.codigoArea);
                  localStorage.setItem('userAreaName', isValid.nombreArea);
                }
                if (isValid.perfil) {
                  localStorage.setItem('userPerfil', isValid.perfil);
                }
                
                // Actualizar campo de usuario
                const inputUsuario = document.getElementById('inputUsuario');
                if (inputUsuario) {
                  inputUsuario.value = cleanUser;
                  inputUsuario.readOnly = true;
                  inputUsuario.classList.add('text-muted');
                  inputUsuario.style.backgroundColor = '#f8f9fa';
                }
                
                console.log(`Usuario ${cleanUser} validado y configurado autom√°ticamente`);
              } else {
                console.warn(`Usuario ${cleanUser} no v√°lido en sistemas comunes o SIEF`);
              }
            }
          } catch (error) {
            console.warn('Error en auto-detecci√≥n:', error);
          }
        }
        
        // Funci√≥n para resetear configuraci√≥n (solo para admin)
        function resetUserConfig() {
          if (confirm('¬øEst√° seguro de que desea resetear la configuraci√≥n de usuario?')) {
            localStorage.removeItem('detectedWindowsUser');
            localStorage.removeItem('userConfigured');
            localStorage.removeItem('userPromptShown');
            alert('Configuraci√≥n reseteada. Recargue la p√°gina.');
          }
        }
    </script>
  </body>
</html>
