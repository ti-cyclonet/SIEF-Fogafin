<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Acceso Interno - Gestión SIEF</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="./assets/styles-login.css"
    />
  </head>
  <body>
    <div class="login-container text-center">
      <div class="login-header mb-4">
        <img
          src="./assets/images/logo.svg"
          alt="Logo Fogafín"
          class="mb-3"
        />
        <h4>Aplicativo de Gestión Interna</h4>
      </div>

      <form id="loginForm">
        <div class="mb-3">
          <div class="text-center">
            <label class="form-label">Usuario:</label>
            <div class="fw-bold text-primary" id="usuarioLabel">No configurado</div>
          </div>
          <input type="hidden" id="inputUsuario" required />
        </div>


        <div class="mb-3 d-flex justify-content-start align-items-center">
          <input
            type="checkbox"
            class="form-check-input me-2"
            id="checkRobot"
            required
          />
          <label class="form-check-label me-3" for="checkRobot"
            >No soy un robot</label
          >
          <div class="ms-auto"><small>reCAPTCHA</small></div>
        </div>

        <button type="submit" class="btn btn-ingresar w-100 mt-2">
          <i class="fas fa-sign-in-alt me-2"></i> Ingresar
        </button>

        <a href="#" class="d-block mt-3 text-primary" style="font-size: 0.9em" onclick="configureUser(); return false;">
          <i class="fas fa-user-cog me-1"></i> Configurar usuario automático
        </a>
        <!-- <div id="debugInfo" class="mt-2 small text-muted"></div> -->
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="./assets/js/windows-auth.js"></script>
    <script src="./assets/js/user-detector.js"></script>
    <script src="./config.js"></script>
    <script>
      // Utilidad para autenticación de Windows
      class WindowsAuth {
        static async obtenerUsuarioWindows() {
          // Usar la nueva utilidad que funciona en local y nube
          const usuario = await WindowsAuthHelper.iniciarSesionAutomatica();
          
          // Fallback al backend si no se obtuvo usuario
          if (!usuario) {
            try {
              // Obtener usuario detectado localmente
              const usuarioLocal = localStorage.getItem('detectedWindowsUser');
              
              // Solo proceder si hay usuario local válido
              if (usuarioLocal) {
                const params = { user: usuarioLocal };
                const headers = { 
                  'Accept': 'text/plain',
                  'X-User-Identity': usuarioLocal
                };
                
                const url = getApiUrl('whoami', params);
                
                const response = await fetch(url, {
                  method: 'GET',
                  credentials: 'include',
                  headers: headers
                });
                
                if (response.ok) {
                  const usuarioBackend = await response.text();
                  return usuarioBackend.trim();
                }
              }
            } catch (error) {
              console.warn('Error obteniendo usuario desde backend:', error);
            }
            return null;
          }
          
          return usuario;
        }

        static async intentarLoginAutomatico() {
          const usuario = await this.obtenerUsuarioWindows();
          if (usuario && usuario.trim() !== '') {
            // Validar usuario antes de permitir login automático
            const validacion = await validarUsuarioResponsable(usuario);
            if (validacion && validacion.esValido) {
              // Si es válido, guardar configuración permanente
              localStorage.setItem('detectedWindowsUser', usuario);
              localStorage.setItem('userConfigured', 'true');
              return validacion;
            }
          }
          return null;
        }
      }
    </script>
    <script>
      // Variables de control
      let modoAutomatico = true;
      
      // Configuración de API
      const isLocal = window.location.hostname === "localhost";
      const API_BASE_URL = isLocal
        ? "http://localhost:7176/api"
        : "https://rg-funciones-inscripcion-d0dpgpfrcmh8gxdg.eastus2-01.azurewebsites.net/api";
      
      // Usar función del config.js
      
      // Obtener usuario del backend e intentar login automático
      document.addEventListener('DOMContentLoaded', async function() {
        try {
          // Auto-detectar usuario si no está configurado
          const yaConfigurado = localStorage.getItem('userConfigured') === 'true';
          if (!yaConfigurado) {
            await autoDetectAndConfigureUser();
          }
          

          
          // Verificar si se debe omitir login automático
          const params = new URLSearchParams(window.location.search);
          const omitirAuto = params.get('manual') === 'true' || localStorage.getItem('skipAutoLogin') === 'true';
          
          // Limpiar bandera de omitir login automático
          if (localStorage.getItem('skipAutoLogin')) {
            localStorage.removeItem('skipAutoLogin');
          }
          
          // Intentar login automático primero (si no está deshabilitado)
          const loginAutomatico = omitirAuto ? null : await WindowsAuth.intentarLoginAutomatico();
          
          if (loginAutomatico && loginAutomatico.esValido) {
            // Login automático exitoso
            const usuario = await WindowsAuth.obtenerUsuarioWindows();
            localStorage.setItem("currentUser", usuario);
            if (loginAutomatico.codigoArea) {
              localStorage.setItem("userArea", loginAutomatico.codigoArea);
              localStorage.setItem("userAreaName", loginAutomatico.nombreArea);
            }
            if (loginAutomatico.perfil) {
              localStorage.setItem("userPerfil", loginAutomatico.perfil);
            }
            
            // Redireccionar directamente al dashboard
            window.location.href = "pages/dashboard.html";
            return;
          }
          
          // Si no hay login automático, mostrar usuario configurado
          const inputUsuario = document.getElementById('inputUsuario');
          const usuarioLabel = document.getElementById('usuarioLabel');
          const usuarioDetectado = localStorage.getItem('detectedWindowsUser');
          
          if (usuarioDetectado) {
            inputUsuario.value = usuarioDetectado;
            usuarioLabel.textContent = usuarioDetectado;
          } else {
            inputUsuario.value = '';
            usuarioLabel.textContent = 'No configurado';
          }
        } catch (error) {
          // Silencioso - mostrar formulario normal
        }
        

      });
      
      // Validación de usuario en tabla TM04_Responsables
      async function validarUsuarioResponsable(usuario) {
        try {
          const response = await fetch(getApiUrl('validar-usuario'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ usuario: usuario })
          });
          
          if (response.ok) {
            const result = await response.json();
            return result;
          }
          return false;
        } catch (error) {
          console.error('Error validando usuario:', error);
          return false;
        }
      }

      document
        .getElementById("loginForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          const usuario = document.getElementById("inputUsuario").value;
          
          // Mostrar loading
          Swal.fire({
            title: "Validando usuario...",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
          });

          try {
            // Validar usuario en tabla TM04_Responsables
            const isAuthorized = await validarUsuarioResponsable(usuario);
            
            Swal.close();
            
            if (isAuthorized.esValido) {
              localStorage.setItem("currentUser", usuario);
              if (isAuthorized.codigoArea) {
                localStorage.setItem("userArea", isAuthorized.codigoArea);
                localStorage.setItem("userAreaName", isAuthorized.nombreArea);
                console.log(`Usuario ${usuario} pertenece al área: ${isAuthorized.nombreArea} (Código: ${isAuthorized.codigoArea})`);
              }
              if (isAuthorized.perfil) {
                localStorage.setItem("userPerfil", isAuthorized.perfil);
                console.log(`Perfil del usuario: ${isAuthorized.perfil}`);
              }

              Swal.fire({
                title: "Acceso concedido",
                text: "Redirigiendo al Dashboard...",
                icon: "success",
                timer: 800,
                showConfirmButton: false,
                willClose: () => {
                  window.location.href = "pages/dashboard.html";
                },
              });
            } else {
              Swal.fire({
                icon: "error",
                title: "¡Acceso Denegado!",
                html: "El usuario no está autorizado para acceder al sistema.",
                confirmButtonText: "Aceptar",
                confirmButtonColor: "#dc3545",
              });
            }
          } catch (error) {
            Swal.close();
            Swal.fire({
              icon: "error",
              title: "Error de conexión",
              text: "No se pudo validar el usuario. Intente nuevamente.",
              confirmButtonText: "Aceptar",
              confirmButtonColor: "#dc3545",
            });
          }
        });
        
        // Función de prueba para debug
        async function testUserDetection() {
          const debugDiv = document.getElementById('debugInfo');
          
          // 1. Configurar usuario de prueba
          localStorage.setItem('detectedWindowsUser', 'jgarzon');
          
          // 2. Construir URL
          const params = { user: 'jgarzon' };
          const url = getApiUrl('whoami', params);
          
          debugDiv.innerHTML = `
            <strong>Debug Info:</strong><br>
            Usuario en localStorage: ${localStorage.getItem('detectedWindowsUser')}<br>
            URL generada: ${url}<br>
          `;
          
          // 3. Hacer llamada
          try {
            const response = await fetch(url, {
              method: 'GET',
              headers: { 'X-User-Identity': 'jgarzon' }
            });
            
            const usuario = await response.text();
            debugDiv.innerHTML += `Respuesta del backend: <strong>${usuario}</strong><br>`;
            
            if (usuario === 'jgarzon') {
              debugDiv.innerHTML += '<span style="color: green;">✅ ¡Funciona correctamente!</span>';
            } else {
              debugDiv.innerHTML += '<span style="color: red;">❌ Aún devuelve adminSief</span>';
            }
            
          } catch (error) {
            debugDiv.innerHTML += `Error: ${error.message}`;
          }
        }
        
        // Detectar usuario real del sistema
        async function detectRealUser() {
          const debugDiv = document.getElementById('debugInfo');
          
          // 1. Limpiar localStorage
          localStorage.removeItem('detectedWindowsUser');
          localStorage.removeItem('userPromptShown');
          
          debugDiv.innerHTML = 'Detectando usuario real del sistema...<br>';
          
          // 2. Intentar detectar usuario real
          const usuarioReal = await WindowsAuthHelper.obtenerUsuarioWindows();
          
          debugDiv.innerHTML += `Usuario detectado: <strong>${usuarioReal}</strong><br>`;
          
          // 3. Probar con el backend
          if (usuarioReal) {
            const params = { user: usuarioReal };
            const url = getApiUrl('whoami', params);
            
            try {
              const response = await fetch(url, {
                method: 'GET',
                headers: { 'X-User-Identity': usuarioReal }
              });
              
              const usuarioBackend = await response.text();
              debugDiv.innerHTML += `Respuesta del backend: <strong>${usuarioBackend}</strong><br>`;
              
              // 4. Guardar permanentemente si funciona
              if (usuarioBackend === usuarioReal) {
                localStorage.setItem('detectedWindowsUser', usuarioReal);
                localStorage.setItem('userConfigured', 'true');
                debugDiv.innerHTML += '<span style="color: green;">✅ Usuario guardado permanentemente</span><br>';
              }
              
              // 5. Actualizar campo de usuario
              const inputUsuario = document.getElementById('inputUsuario');
              if (inputUsuario) {
                inputUsuario.value = usuarioReal;
              }
              
            } catch (error) {
              debugDiv.innerHTML += `Error: ${error.message}`;
            }
          } else {
            debugDiv.innerHTML += '<span style="color: orange;">No se pudo detectar usuario automáticamente</span>';
          }
        }
        
        // Configurar usuario manualmente
        async function configureUser() {
          const currentUser = localStorage.getItem('detectedWindowsUser') || '';
          
          const { value: newUser } = await Swal.fire({
            title: 'Configurar Usuario Automático',
            input: 'text',
            inputLabel: 'Ingrese su usuario de Windows para acceso automático:',
            inputValue: currentUser,
            showCancelButton: true,
            confirmButtonText: 'Configurar',
            cancelButtonText: 'Cancelar'
          });
          
          if (newUser && newUser.trim()) {
            const cleanUser = newUser.trim().toLowerCase();
            localStorage.setItem('detectedWindowsUser', cleanUser);
            
            // Actualizar campo de usuario y etiqueta
            const inputUsuario = document.getElementById('inputUsuario');
            const usuarioLabel = document.getElementById('usuarioLabel');
            if (inputUsuario) {
              inputUsuario.value = cleanUser;
            }
            if (usuarioLabel) {
              usuarioLabel.textContent = cleanUser;
            }
            
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML = `<span style="color: green;">✅ Usuario configurado: <strong>${cleanUser}</strong></span><br>`;
            debugDiv.innerHTML += 'La próxima vez se usará automáticamente.';
            
            Swal.fire({
              icon: 'success',
              title: 'Usuario Configurado',
              text: `Usuario ${cleanUser} configurado correctamente`,
              timer: 2000,
              showConfirmButton: false
            });
          }
        }
        
        // Auto-detectar y configurar usuario automáticamente
        async function autoDetectAndConfigureUser() {
          try {
            // Intentar obtener usuario desde el entorno del navegador
            let usuarioDetectado = null;
            
            // Método 1: ActiveX (IE/Edge corporativo)
            try {
              if (typeof ActiveXObject !== 'undefined') {
                const network = new ActiveXObject("WScript.Network");
                usuarioDetectado = network.UserName;
              }
            } catch (e) {}
            
            // Método 2: Desde variables del sistema (si están disponibles)
            if (!usuarioDetectado && typeof process !== 'undefined' && process.env) {
              usuarioDetectado = process.env.USERNAME || process.env.USER;
            }
            
            // Método 3: Prompt único y silencioso
            if (!usuarioDetectado) {
              const hostname = window.location.hostname;
              const isLocal = hostname === 'localhost' || hostname.includes('.local');
              
              if (!isLocal) {
                // En nube, usar SweetAlert2 una sola vez
                const { value: usuario } = await Swal.fire({
                  title: 'Configuración Inicial',
                  input: 'text',
                  inputLabel: 'Ingrese su usuario de Windows para acceso automático:',
                  showCancelButton: false,
                  allowOutsideClick: false,
                  confirmButtonText: 'Continuar'
                });
                usuarioDetectado = usuario;
              }
            }
            
            // Si se detectó usuario, validarlo con el backend
            if (usuarioDetectado && usuarioDetectado.trim()) {
              const cleanUser = usuarioDetectado.trim().toLowerCase();
              
              // Validar usuario en sistemas comunes y SIEF
              const isValid = await validarUsuarioResponsable(cleanUser);
              
              if (isValid && isValid.esValido) {
                // Usuario válido - guardar permanentemente
                localStorage.setItem('detectedWindowsUser', cleanUser);
                localStorage.setItem('userConfigured', 'true');
                
                // Guardar información adicional del usuario
                if (isValid.codigoArea) {
                  localStorage.setItem('userArea', isValid.codigoArea);
                  localStorage.setItem('userAreaName', isValid.nombreArea);
                }
                if (isValid.perfil) {
                  localStorage.setItem('userPerfil', isValid.perfil);
                }
                
                // Actualizar campo de usuario y etiqueta
                const inputUsuario = document.getElementById('inputUsuario');
                const usuarioLabel = document.getElementById('usuarioLabel');
                if (inputUsuario) {
                  inputUsuario.value = cleanUser;
                }
                if (usuarioLabel) {
                  usuarioLabel.textContent = cleanUser;
                }
                
                console.log(`Usuario ${cleanUser} validado y configurado automáticamente`);
              } else {
                console.warn(`Usuario ${cleanUser} no válido en sistemas comunes o SIEF`);
              }
            }
          } catch (error) {
            console.warn('Error en auto-detección:', error);
          }
        }
        
        // Función para resetear configuración (solo para admin)
        async function resetUserConfig() {
          const result = await Swal.fire({
            title: '¿Está seguro?',
            text: '¿Desea resetear la configuración de usuario?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sí, resetear',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#d33'
          });
          
          if (result.isConfirmed) {
            localStorage.removeItem('detectedWindowsUser');
            localStorage.removeItem('userConfigured');
            localStorage.removeItem('userPromptShown');
            
            Swal.fire({
              icon: 'success',
              title: 'Configuración Reseteada',
              text: 'Recargue la página para aplicar los cambios',
              confirmButtonText: 'Aceptar'
            });
          }
        }
    </script>
  </body>
</html>
