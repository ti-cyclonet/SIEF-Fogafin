<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Consultar Entidades - Aplicativo Interno</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- <link href="../assets/styles-interno.css" rel="stylesheet" /> -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      .gestion-container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 30px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
      }
      .form-info-section {
        border: 1px solid #ddd;
        padding: 20px;
        border-radius: 5px;
        margin-top: 20px;
      }
      .info-field {
        font-weight: bold;
      }
      .nav-tabs .nav-link {
        color: #007bff;
      }
      .nav-tabs .nav-link.active {
        font-weight: bold;
      }
      .readonly-input {
        background-color: #eee;
      }
      .header-bg {
        background: linear-gradient(135deg, #2e7d32 0%, #007bff 100%) !important;
      }
      .btn-outline-light:hover {
        background-color: #007bff;
        border-color: #007bff;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="header-bg bg-primary text-white py-3">
        <div class="container d-flex justify-content-between align-items-center">
            <h3>Gestión SIEF - Aplicativo Interno</h3>
            <div class="d-flex align-items-center">
                <div class="me-3 text-end">
                    <div><i class="fas fa-user-circle"></i> <span id="nombreFuncionario">Cargando...</span></div>
                    <small class="text-light opacity-75" id="departamentoFuncionario">Cargando...</small>
                </div>
                <button class="btn btn-sm btn-outline-light" id="btnSalir"><i class="fas fa-sign-out-alt"></i> Salir</button>
            </div>
        </div>
    </div>

    <div class="gestion-container">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h4>Consultar entidades</h4>
          <p class="text-muted mb-0">
            Selecciona una entidad para consultar el historial de la gestión realizada
          </p>
        </div>

      </div>

      <!-- Filtros -->
      <div class="mb-4">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label fw-bold">Sector:</label>
            <select id="selectSector" class="form-select">
              <option value="">Todos los sectores</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-bold">Nombre de entidad:</label>
            <input type="text" id="buscarEntidad" class="form-control" placeholder="Buscar por nombre..." />
          </div>
          <div class="col-md-4">
            <label class="form-label fw-bold">Estado del trámite:</label>
            <select id="selectEstado" class="form-select">
              <option value="">Todos los estados</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Línea verde antes de la tabla -->
      <hr style="border-color: #28a745; opacity: 0.6; margin: 0;">
      
      <!-- Tabla de resultados -->
      <div id="tablaResultados">
        <div class="table-responsive">
          <table class="table table-striped table-hover" style="font-size: 0.75rem;">
            <thead class="table-light">
              <tr>
                <th>Sector</th>
                <th>Entidad</th>
                <th>Nombre de la entidad</th>
                <th>NIT</th>
                <th>Fecha de inscripción</th>
                <th>Nombre Representante</th>
                <th>Correo notificación</th>
                <th>Capital suscrito</th>
                <th>Pago inscripción</th>
                <th>Fecha de pago</th>
                <th>Estado del trámite</th>
              </tr>
            </thead>
            <tbody id="tablaEntidadesBody">
              <tr>
                <td colspan="11" class="text-center text-muted py-4">
                  <i class="fas fa-spinner fa-spin me-2"></i>Cargando entidades...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- Línea verde después de la tabla -->
        <hr style="border-color: #28a745; opacity: 0.6; margin: 0;">
        
        <!-- Controles debajo de la tabla -->
        <div class="row mt-3">
          <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <button type="button" class="btn btn-outline-secondary me-2" id="btnLimpiarFiltros">
                  <i class="fas fa-eraser me-1"></i>Limpiar filtros
                </button>
                <button type="button" class="btn btn-outline-success me-2" id="btnExportar">
                  <i class="fas fa-download me-1"></i>Exportar
                </button>
                <button type="button" class="btn btn-outline-primary" id="btnCerrar">
                  <i class="fas fa-times me-1"></i>Cerrar
                </button>
              </div>
              <div>
                <small class="text-muted" id="leyendaResultados">Cargando...</small>
              </div>
              <div>
                <nav aria-label="Paginación de entidades">
                  <ul class="pagination mb-0" id="paginacion">
                    <!-- Se genera dinámicamente -->
                  </ul>
                </nav>
              </div>
            </div>
          </div>
        </div>

      </div>



      <div id="detalleEntidad" class="form-info-section d-none">
        <ul class="nav nav-tabs" id="entidadTab" role="tablist">
          <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" data-bs-target="#informacionGeneral" type="button">
              Información general
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" data-bs-target="#informacionPago" type="button">
              Información de la inscripción y pago
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" data-bs-target="#historialGestion" type="button">
              Historial de gestión
            </a>
          </li>
        </ul>

        <div class="tab-content">
          <div class="tab-pane fade show active" id="informacionGeneral" role="tabpanel">
            <div class="py-3">
              <h6 class="text-success">Información del Representante legal o apoderado</h6>
              <table class="table table-borderless mt-3">
                <tbody>
                  <tr>
                    <td class="fw-bold" style="width: 25%;">Nombre(s) y Apellido(s):</td>
                    <td><span id="nombreRepresentante" class="text-muted">Información xxxxx</span></td>
                  </tr>
                  <tr>
                    <td class="fw-bold">Tipo de identificación:</td>
                    <td><span id="tipoIdentificacion" class="text-muted">Información xxxxx</span></td>
                  </tr>
                  <tr>
                    <td class="fw-bold">Número de documento:</td>
                    <td><span id="numeroDocumento" class="text-muted">Información xxxxx</span></td>
                  </tr>
                  <tr>
                    <td class="fw-bold">Correo electrónico:</td>
                    <td><span id="correoRepresentante" class="text-muted">Información xxxxx</span></td>
                  </tr>
                  <tr>
                    <td class="fw-bold">Teléfono:</td>
                    <td><span id="telefonoRepresentante" class="text-muted">Información xxxxx</span></td>
                  </tr>
                  <tr>
                    <td class="fw-bold">Cargo:</td>
                    <td><span id="cargoRepresentante" class="text-muted">Información xxxxx</span></td>
                  </tr>
                </tbody>
              </table>
              
              <h6 class="text-success mt-4">Información del responsable del registro</h6>
              <table class="table table-borderless mt-3">
                <tbody>
                  <tr>
                    <td class="fw-bold" style="width: 25%;">Nombre(s) y Apellido(s):</td>
                    <td><span id="nombreResponsable" class="text-muted">Información xxxxx</span></td>
                  </tr>
                  <tr>
                    <td class="fw-bold">Correo electrónico:</td>
                    <td><span id="correoResponsable" class="text-muted">Información xxxxx</span></td>
                  </tr>
                  <tr>
                    <td class="fw-bold">Teléfono:</td>
                    <td><span id="telefonoResponsable" class="text-muted">Información xxxxx</span></td>
                  </tr>
                </tbody>
              </table>
              
              <h6 class="text-success mt-4">Archivos de la solicitud</h6>
              <table class="table table-borderless mt-3">
                <tbody>
                  <tr>
                    <td class="fw-bold" style="width: 25%;">Certificado de existencia:</td>
                    <td><a href="#" id="linkCertificado" class="text-primary">a link</a></td>
                  </tr>
                  <tr>
                    <td class="fw-bold">Resolución:</td>
                    <td><a href="#" id="linkResolucion" class="text-primary">a link</a></td>
                  </tr>
                  <tr>
                    <td class="fw-bold">Inscripción de terceros:</td>
                    <td><a href="#" id="linkTerceros" class="text-primary">a link</a></td>
                  </tr>
                  <tr>
                    <td class="fw-bold">Logo:</td>
                    <td><a href="#" id="linkLogo" class="text-primary">a link</a></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="tab-pane fade" id="informacionPago" role="tabpanel">
            <div class="py-3">
              <h6 class="text-success">Información de inscripción de la entidad</h6>
              <table class="table table-borderless mt-3">
                <tbody>
                  <tr>
                    <td class="fw-bold" style="width: 40%;">Fecha de resolución de constitución *</td>
                    <td><span id="fechaConstitucion">Información xxxxx</span></td>
                  </tr>
                  <tr>
                    <td class="fw-bold">Capital suscrito *</td>
                    <td><span id="capitalSuscrito">Información xxxxx</span></td>
                  </tr>
                </tbody>
              </table>
              
              <h6 class="text-success mt-4">Información del pago de la inscripción</h6>
              <table class="table table-borderless mt-3">
                <tbody>
                  <tr>
                    <td class="fw-bold" style="width: 40%;">Valor pagado por inscripción*</td>
                    <td><span id="valorPagado">Información xxxxx</span></td>
                  </tr>
                  <tr>
                    <td class="fw-bold">Fecha de pago de la inscripción*</td>
                    <td><span id="fechaPago">Información xxxxx</span></td>
                  </tr>
                  <tr>
                    <td class="fw-bold">Soporte de pago*</td>
                    <td><a href="#" id="linkSoportePago" class="text-primary">a link</a></td>
                  </tr>
                </tbody>
              </table>
              

            </div>
          </div>

          <div class="tab-pane fade" id="historialGestion" role="tabpanel">
            <div class="py-3">
              <h6 class="text-success">Historial de gestión</h6>
              <div class="table-responsive mt-3">
                <table class="table table-striped table-hover" id="tablaHistorial">
                  <thead class="table-light">
                    <tr>
                      <th>Fecha</th>
                      <th>Estado anterior</th>
                      <th>Estado actual</th>
                      <th>Usuario</th>
                      <th>Observaciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="5" class="text-center text-muted">Seleccione una entidad para ver el historial</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../config.js"></script>
    <script>
      // 1. Constantes de la API y Elementos
      const isLocal = window.location.hostname === "localhost";
      const API_BASE_URL = isLocal
        ? "http://localhost:7176/api/"
        : "https://rg-funciones-inscripcion-d0dpgpfrcmh8gxdg.eastus2-01.azurewebsites.net/api/";
      
      // Usar función del config.js

      const selectEntidadGestion = document.getElementById(
        "selectEntidadGestion"
      );
      const gestionEstado = document.getElementById("gestionEstado");
      const detalleGestion = document.getElementById("detalleGestion");
      const btnAprobarDocs = document.getElementById("btnAprobarDocumentos");
      const btnAprobarInsc = document.getElementById("btnAprobarInscripcion");
      const btnRechazarInsc = document.getElementById("btnRechazarInscripcion");

      // --- Funciones de Carga y Lógica de Negocio ---

      /**
       * Carga las entidades que están en estado "gestionable" (documentos, revisión, etc.)
       * Se usará la API de filtro, probablemente filtrando por los IDs de estados que no son "Inscrita" o "Rechazada".
       */
      async function loadEntidadesGestionables() {
        // ⭐️ Aquí deberías pasar los IDs de los estados que quieres gestionar.
        // Ej: estadoId=1 (Solicitud), estadoId=2 (Validación Documentos), estadoId=3 (Revisión Legal)
        const estadosGestionables = "1,2,3";
        const url = `${API_BASE_URL}entidades-filtradas?estadoIds=${estadosGestionables}`;

        try {
          const response = await fetch(url);
          if (!response.ok)
            throw new Error("Error al cargar entidades para gestión.");

          const entidades = await response.json();
          selectEntidadGestion.innerHTML =
            '<option value="">Seleccione...</option>';

          entidades.forEach((e) =>
            selectEntidadGestion.insertAdjacentHTML(
              "beforeend",
              `<option value="${e.id}" data-estado-id="${e.estadoId}" data-estado-nombre="${e.estadoNombre}">${e.razonSocial} (${e.estadoNombre})</option>`
            )
          );
        } catch (error) {
          Swal.fire(
            "Error de Carga",
            "No se pudieron cargar las entidades gestionables.",
            "error"
          );
          console.error(error);
        }
      }

      /**
       * Actualiza la información de cabecera y habilita/deshabilita botones de gestión.
       */
      function actualizarUI(entidadId) {
        detalleGestion.classList.add("d-none");
        btnAprobarDocs.disabled = true;
        btnAprobarInsc.disabled = true;
        btnRechazarInsc.disabled = true;

        if (!entidadId) {
          document.getElementById("gestionTipoEntidad").value = "";
          document.getElementById("gestionNit").value = "";
          gestionEstado.value = "";
          return;
        }

        const selectedOption =
          selectEntidadGestion.options[selectEntidadGestion.selectedIndex];
        const estadoNombre = selectedOption.dataset.estadoNombre;
        const estadoId = selectedOption.dataset.estadoId;

        // 1. Mostrar estado actual
        gestionEstado.value = estadoNombre;

        // 2. Simular carga de detalle (Debería usar la API: /api/consultar-entidad-detalle/{id})
        // Por simplicidad, simulamos la carga de otros campos aquí
        document.getElementById("gestionTipoEntidad").value =
          "Establecimiento bancario (Simulado)";
        document.getElementById("gestionNit").value = "987654321 (Simulado)";
        detalleGestion.classList.remove("d-none");

        // 3. Habilitar botones basado en el estado (Lógica de Negocio)
        // 1=Solicitud, 2=Validación Documentos, 3=Revisión Legal
        if (estadoId === "2") {
          // Validación de Documentos -> Aprobar Documentos
          btnAprobarDocs.disabled = false;
          btnRechazarInsc.disabled = false;
        } else if (estadoId === "3") {
          // Revisión Legal -> Aprobar Inscripción
          btnAprobarInsc.disabled = false;
          btnRechazarInsc.disabled = false;
        } else {
          // En cualquier otro estado (ej. 1=Solicitud), solo se permite rechazar
          btnRechazarInsc.disabled = false;
        }
      }

      /**
       * Llama a la Azure Function para cambiar el estado del trámite.
       * @param {string} accion - La acción (AprobarDocumentos, AprobarInscripcion, RechazarInscripcion).
       * @param {string} [observaciones] - Observaciones.
       */
      async function ejecutarGestion(accion, observaciones = "") {
        const IdEntidad = selectEntidadGestion.value;
        const funcionario =
          localStorage.getItem("currentUser") || "SSD.Funcionario";

        const requestBody = {
          IdEntidad: parseInt(IdEntidad),
          Accion: accion,
          Observaciones: observaciones,
          Funcionario: funcionario,
        };

        try {
          const response = await fetch(API_BASE_URL + "gestionar-inscripcion", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestBody),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.message ||
                "Error desconocido al gestionar la inscripción."
            );
          }

          const successData = await response.json();

          Swal.fire({
            icon: "success",
            title: "Gestión Exitosa",
            html: `La entidad fue actualizada a: <b>${successData.nuevoEstado}</b>.`,
            confirmButtonText: "Aceptar",
          }).then(() => {
            // Recargar la lista de entidades gestionables
            loadEntidadesGestionables();
            // Limpiar la UI
            actualizarUI(null);
          });
        } catch (error) {
          Swal.fire("Error de Gestión", error.message, "error");
        }
      }

      // --- Funciones de Confirmación (SweetAlert2) ---

      function confirmarGestion(accion) {
        let titulo =
          accion === "AprobarDocumentos"
            ? "Aprobar Documentos"
            : "Aprobar Inscripción";
        let texto =
          accion === "AprobarDocumentos"
            ? "¿Confirma que los documentos son correctos y desea pasar la solicitud a Revisión Legal?"
            : "¿Confirma la aprobación final y la inscripción de la entidad?";

        Swal.fire({
          icon: "question",
          title: titulo,
          text: texto,
          showCancelButton: true,
          confirmButtonText: "Sí, Continuar",
          cancelButtonText: "Cancelar",
        }).then((result) => {
          if (result.isConfirmed) {
            ejecutarGestion(accion);
          }
        });
      }

      function confirmarRechazo() {
        Swal.fire({
          icon: "warning",
          title: "Rechazar Solicitud",
          text: "Ingrese el motivo del rechazo. Este será visible para la entidad.",
          input: "textarea",
          inputPlaceholder: "Ingrese el motivo detallado del rechazo aquí...",
          inputValidator: (value) => {
            if (!value) return "¡Debe ingresar un motivo de rechazo!";
          },
          showCancelButton: true,
          confirmButtonText: "Rechazar Inscripción",
          cancelButtonText: "Cancelar",
        }).then((result) => {
          if (result.isConfirmed) {
            ejecutarGestion("RechazarInscripcion", result.value);
          }
        });
      }

      // --- Eventos ---

      // 1. Inicialización y carga de usuario
      document.addEventListener("DOMContentLoaded", () => {
        // Cargar información del usuario
        const userName = localStorage.getItem('currentUser');
        const funcionarioSpan = document.getElementById('nombreFuncionario');
        const departamentoSpan = document.getElementById('departamentoFuncionario');
        
        if (userName && funcionarioSpan) {
          const parts = userName.split('.');
          const displayUser = parts.map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(' ');
          funcionarioSpan.textContent = displayUser;
          
          // Obtener información del área desde localStorage
          const userAreaName = localStorage.getItem('userAreaName');
          let tipoUsuario = 'Funcionario';
          let departamento = '';
          
          const userPerfil = localStorage.getItem('userPerfil');
          
          if (userName.toLowerCase() === 'adminsief') {
            tipoUsuario = 'Administrador SIEF';
          } else if (userPerfil) {
            tipoUsuario = userPerfil === 'Profesional DOT' ? 'Jefe / Profesional DOT' : userPerfil;
          } else if (userAreaName) {
            departamento = userAreaName;
          } else {
            const userArea = localStorage.getItem('userArea');
            const userRole = localStorage.getItem('userRole');
            departamento = userRole === 'Jefe' ? 'Jefe SSD' : 'SSD';
          }
          
          departamentoSpan.textContent = userPerfil ? tipoUsuario : (departamento ? `${tipoUsuario} ${departamento}` : tipoUsuario);
        } else {
          window.location.href = '../index.html';
          return;
        }
        
        // Botón de salir
        document.getElementById('btnSalir').addEventListener('click', () => {
          localStorage.removeItem('currentUser');
          localStorage.removeItem('userArea');
          localStorage.removeItem('userAreaName');
          window.location.href = '../index.html';
        });
        
        // Cargar sectores y estados
        cargarSectores();
        cargarEstados();
        
        // Cargar todas las entidades al inicio
        cargarTodasLasEntidades();
        
        // Event listeners para filtros en tiempo real
        document.getElementById('selectSector').addEventListener('change', aplicarFiltros);
        document.getElementById('buscarEntidad').addEventListener('input', aplicarFiltros);
        document.getElementById('selectEstado').addEventListener('change', aplicarFiltros);
        
        document.getElementById('btnLimpiarFiltros').addEventListener('click', () => {
          document.getElementById('selectSector').value = '';
          document.getElementById('buscarEntidad').value = '';
          document.getElementById('selectEstado').value = '';
          aplicarFiltros();
        });
        
        // Botón cerrar
        document.getElementById('btnCerrar').addEventListener('click', () => {
          window.location.href = 'dashboard.html';
        });
        
        // Botón exportar
        document.getElementById('btnExportar').addEventListener('click', exportarAExcel);
      });

      // Función para cargar sectores desde el endpoint
      async function cargarSectores() {
        const selectSector = document.getElementById('selectSector');
        selectSector.innerHTML = '<option value="">Todos los sectores</option>';

        const codigosFiltro = [1, 2, 4, 28];
        const URL_SECTORES = getApiUrl(`ConsultarSectores/${codigosFiltro.join(',')}`);

        try {
          const response = await fetch(URL_SECTORES);
          
          if (!response.ok) {
            throw new Error('Error al obtener los sectores financieros');
          }

          const sectores = await response.json();

          sectores.forEach((sector) => {
            const option = document.createElement('option');
            option.value = sector.TM01_CODIGO;
            option.textContent = sector.TM01_NOMBRE;
            selectSector.appendChild(option);
          });
        } catch (error) {
          console.error('Error al cargar sectores:', error);
        }
      }

      // Función para cargar estados
      async function cargarEstados() {
        const selectEstado = document.getElementById('selectEstado');
        selectEstado.innerHTML = '<option value="">Todos los estados</option>';

        try {
          const response = await fetch(getApiUrl('ConsultarEstados'));
          
          if (!response.ok) {
            throw new Error('Error al obtener los estados');
          }

          const estados = await response.json();

          estados.forEach((estado) => {
            const option = document.createElement('option');
            option.value = estado.id;
            option.textContent = estado.nombre;
            selectEstado.appendChild(option);
          });
        } catch (error) {
          console.error('Error al cargar estados:', error);
        }
      }

      let entidadesData = [];
      let entidadesFiltradas = [];
      let paginaActual = 1;
      const entidadesPorPagina = 8;

      // Función para cargar todas las entidades
      async function cargarTodasLasEntidades() {
        const tbody = document.getElementById('tablaEntidadesBody');
        tbody.innerHTML = '<tr><td colspan="12" class="text-center text-muted py-4"><i class="fas fa-spinner fa-spin me-2"></i>Cargando entidades...</td></tr>';

        try {
          const response = await fetch(getApiUrl('ConsultarTodasEntidades'));
          
          if (!response.ok) {
            throw new Error('Error al obtener las entidades');
          }

          entidadesData = await response.json();
          entidadesFiltradas = [...entidadesData];
          paginaActual = 1;
          mostrarEntidadesPaginadas();
        } catch (error) {
          console.error('Error al cargar entidades:', error);
          tbody.innerHTML = '<tr><td colspan="11" class="text-center text-danger py-4">Error al cargar las entidades</td></tr>';
        }
      }

      // Función para aplicar filtros
      function aplicarFiltros() {
        const sectorId = document.getElementById('selectSector').value;
        const nombreEntidad = document.getElementById('buscarEntidad').value.toLowerCase();
        const estadoId = document.getElementById('selectEstado').value;

        entidadesFiltradas = entidadesData.filter(entidad => {
          const cumpleSector = !sectorId || entidad.SectorId == sectorId;
          const cumpleNombre = !nombreEntidad || entidad.Nombre.toLowerCase().includes(nombreEntidad);
          const cumpleEstado = !estadoId || entidad.EstadoId == estadoId;
          
          return cumpleSector && cumpleNombre && cumpleEstado;
        });

        paginaActual = 1;
        mostrarEntidadesPaginadas();
      }

      // Función para mostrar entidades con paginación
      function mostrarEntidadesPaginadas() {
        const tbody = document.getElementById('tablaEntidadesBody');
        const inicio = (paginaActual - 1) * entidadesPorPagina;
        const fin = inicio + entidadesPorPagina;
        const entidadesPagina = entidadesFiltradas.slice(inicio, fin);

        if (entidadesPagina.length === 0) {
          tbody.innerHTML = '<tr><td colspan="11" class="text-center text-muted py-4">No se encontraron entidades con los filtros aplicados</td></tr>';
          generarPaginacion(0);
          return;
        }

        tbody.innerHTML = '';
        entidadesPagina.forEach(entidad => {
          const fila = document.createElement('tr');
          fila.innerHTML = `
            <td>${entidad.SectorId || '-'}</td>
            <td>${entidad.EntidadId && /^999\d{2}$/.test(entidad.EntidadId) ? 'N/A' : (entidad.EntidadId || '-')}</td>
            <td>${entidad.Nombre || '-'}</td>
            <td>${entidad.Nit || '-'}</td>
            <td>${entidad.FechaInscripcion ? new Date(entidad.FechaInscripcion).toLocaleDateString('es-CO') : '-'}</td>
            <td>${entidad.NombreRepresentante || '-'}</td>
            <td>${entidad.CorreoNotificacion || '-'}</td>
            <td>${entidad.CapitalSuscrito ? formatearMoneda(entidad.CapitalSuscrito) : '-'}</td>
            <td>${entidad.ValorPagado ? formatearMonedaConDecimales(entidad.ValorPagado) : '-'}</td>
            <td>${entidad.FechaPago ? new Date(entidad.FechaPago).toLocaleDateString('es-CO') : '-'}</td>
            <td><span class="badge bg-${obtenerColorEstado(entidad.EstadoNombre)}">${entidad.EstadoNombre === 'Sin estado' ? 'Migrado' : (entidad.EstadoNombre || '-')}</span></td>
          `;
          tbody.appendChild(fila);
        });

        generarPaginacion(entidadesFiltradas.length);
        actualizarLeyenda();
      }
      
      // Función para actualizar leyenda de resultados
      function actualizarLeyenda() {
        const inicio = (paginaActual - 1) * entidadesPorPagina + 1;
        const fin = Math.min(paginaActual * entidadesPorPagina, entidadesFiltradas.length);
        const total = entidadesFiltradas.length;
        
        const leyenda = document.getElementById('leyendaResultados');
        if (total === 0) {
          leyenda.textContent = 'No se encontraron entidades';
        } else {
          leyenda.textContent = `Mostrando ${inicio}-${fin} de ${total} entidades${total !== entidadesData.length ? ' filtradas' : ''}`;
        }
      }

      // Función para generar paginación
      function generarPaginacion(totalEntidades) {
        const paginacion = document.getElementById('paginacion');
        const totalPaginas = Math.ceil(totalEntidades / entidadesPorPagina);
        
        paginacion.innerHTML = '';
        
        if (totalPaginas <= 1) return;

        // Botón anterior
        const btnAnterior = document.createElement('li');
        btnAnterior.className = `page-item ${paginaActual === 1 ? 'disabled' : ''}`;
        btnAnterior.innerHTML = '<a class="page-link" href="#" onclick="cambiarPagina(' + (paginaActual - 1) + ')">Anterior</a>';
        paginacion.appendChild(btnAnterior);

        // Calcular rango de páginas a mostrar (5 páginas)
        let inicio = Math.max(1, paginaActual - 2);
        let fin = Math.min(totalPaginas, inicio + 4);
        
        // Ajustar inicio si estamos cerca del final
        if (fin - inicio < 4) {
          inicio = Math.max(1, fin - 4);
        }

        // Números de página
        for (let i = inicio; i <= fin; i++) {
          const btnPagina = document.createElement('li');
          btnPagina.className = `page-item ${i === paginaActual ? 'active' : ''}`;
          btnPagina.innerHTML = '<a class="page-link" href="#" onclick="cambiarPagina(' + i + ')">' + i + '</a>';
          paginacion.appendChild(btnPagina);
        }

        // Botón siguiente
        const btnSiguiente = document.createElement('li');
        btnSiguiente.className = `page-item ${paginaActual === totalPaginas ? 'disabled' : ''}`;
        btnSiguiente.innerHTML = '<a class="page-link" href="#" onclick="cambiarPagina(' + (paginaActual + 1) + ')">Siguiente</a>';
        paginacion.appendChild(btnSiguiente);
      }

      // Función para cambiar página
      function cambiarPagina(nuevaPagina) {
        const totalPaginas = Math.ceil(entidadesFiltradas.length / entidadesPorPagina);
        if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas) {
          paginaActual = nuevaPagina;
          mostrarEntidadesPaginadas();
        }
      }

      // Función para obtener color del estado
      function obtenerColorEstado(estado) {
        const colores = {
          'Inscrita': 'success',
          'Rechazada': 'danger',
          'En validación de documentos': 'warning',
          'Pendiente de aprobación final': 'info',
          'Confirmación de pago': 'primary',
          'En revisión': 'secondary',
          'Pendiente': 'light',
          'Aprobada': 'success',
          'Cancelada': 'dark',
          'Sin estado': 'secondary',
          'Migrado': 'secondary'
        };
        return colores[estado] || 'primary';
      }

      // Función para ver detalle de entidad
      function verDetalleEntidad(entidadId) {
        window.location.href = `detalle-entidad.html?id=${entidadId}`;
      }
      
      // Función para exportar a Excel
      function exportarAExcel() {
        if (entidadesFiltradas.length === 0) {
          alert('No hay datos para exportar');
          return;
        }
        
        // Crear datos para Excel
        const datosExcel = entidadesFiltradas.map(entidad => ({
          'Sector': entidad.SectorId || '',
          'Entidad': entidad.EntidadId && /^999\d{2}$/.test(entidad.EntidadId) ? 'N/A' : (entidad.EntidadId || ''),
          'Nombre de la entidad': entidad.Nombre || '',
          'NIT': entidad.Nit || '',
          'Fecha de inscripción': entidad.FechaInscripcion ? new Date(entidad.FechaInscripcion).toLocaleDateString('es-CO') : '',
          'Nombre Representante': entidad.NombreRepresentante || '',
          'Correo notificación': entidad.CorreoNotificacion || '',
          'Capital suscrito': entidad.CapitalSuscrito ? formatearMoneda(entidad.CapitalSuscrito) : '',
          'Pago inscripción': entidad.ValorPagado ? formatearMonedaConDecimales(entidad.ValorPagado) : '',
          'Fecha de pago': entidad.FechaPago ? new Date(entidad.FechaPago).toLocaleDateString('es-CO') : '',
          'Estado del trámite': entidad.EstadoNombre || ''
        }));
        
        // Convertir a CSV
        const headers = Object.keys(datosExcel[0]);
        const csvContent = [
          headers.join(','),
          ...datosExcel.map(row => headers.map(header => `"${row[header]}"`).join(','))
        ].join('\n');
        
        // Crear y descargar archivo con BOM para UTF-8
        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `entidades_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }



      // Función para formatear moneda
      function formatearMoneda(valor) {
        return "$" + Number(valor).toLocaleString("es-CO", {minimumFractionDigits: 0, maximumFractionDigits: 0});
      }

      function formatearMonedaConDecimales(valor) {
        return "$" + Number(valor).toLocaleString("es-CO", {minimumFractionDigits: 2, maximumFractionDigits: 2});
      }











      // 2. Evento al cambiar la entidad seleccionada
      selectEntidadGestion.addEventListener("change", (e) =>
        actualizarUI(e.target.value)
      );

      // 3. Eventos de los botones de gestión
      btnAprobarDocs.addEventListener("click", () =>
        confirmarGestion("AprobarDocumentos")
      );
      btnAprobarInsc.addEventListener("click", () =>
        confirmarGestion("AprobarInscripcion")
      );
      btnRechazarInsc.addEventListener("click", confirmarRechazo);
    </script>
  </body>
</html>
