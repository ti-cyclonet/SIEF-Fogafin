<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Detalle y Gesti√≥n de Solicitud - Interno</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <link rel="stylesheet" href="../assets/styles-detalles.css" />
</head>
<body>
    
    <div class="header-bg">
        <div class="container d-flex justify-content-between align-items-center">
            <h3>Gesti√≥n SIEF</h3>
            <a href="dashboard.html" class="btn btn-sm btn-outline-light"><i class="fas fa-arrow-left"></i> Volver al Dashboard</a>
        </div>
    </div>

    <div class="container">
        <div class="main-card">
            <h4 class="mb-4 text-center">
                Revisi√≥n Solicitud: <span id="tramiteIdDisplay">Cargando...</span> - 
                <span id="entidadNombreDisplay"></span>
                <span id="estadoActualDisplay" class="ms-3 status-badge"></span>
            </h4>

            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="datos-tab" data-bs-toggle="tab" data-bs-target="#datos-pane" type="button" role="tab">Datos de la Entidad</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="documentos-tab" data-bs-toggle="tab" data-bs-target="#documentos-pane" type="button" role="tab">Documentos Cargados</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="gestion-tab" data-bs-toggle="tab" data-bs-target="#gestion-pane" type="button" role="tab">Gesti√≥n y Estado</button>
                </li>
            </ul>

            <div class="tab-content pt-3" id="myTabContent">
                
                <div class="tab-pane fade show active" id="datos-pane" role="tabpanel" tabindex="0">
                    <div id="datosGenerales" class="row g-3">
                        </div>
                </div>

                <div class="tab-pane fade" id="documentos-pane" role="tabpanel" tabindex="0">
                    <h6 class="section-title">Documentos para Revisi√≥n</h6>
                    <ul id="documentosList" class="list-group">
                        </ul>
                </div>

                <div class="tab-pane fade" id="gestion-pane" role="tabpanel" tabindex="0">
                    <h6 class="section-title">Cambio de Estado y Bit√°cora</h6>
                    
                    <form id="formGestionEstado" class="p-3 border rounded mb-4 bg-light">
                        <h6 class="mb-3">Actualizar Estado:</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="nuevoEstado" class="form-label">Nuevo Estado</label>
                                <select id="nuevoEstado" class="form-select" required>
                                    <option value="">Seleccione...</option>
                                    <option value="2">En Revisi√≥n Legal</option>
                                    <option value="3">Aprobado</option>
                                    <option value="4">Rechazado</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="areaResponsable" class="form-label">√Årea Responsable</label>
                                <input id="areaResponsable" class="form-control" type="text" value="Legal" disabled>
                            </div>
                        </div>
                        
                        <div class="mb-3 mt-3">
                            <label for="observaciones" class="form-label">Observaciones de la Gesti√≥n:</label>
                            <textarea id="observaciones" class="form-control" rows="3" required placeholder="Detalle los motivos del cambio de estado..."></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-update mt-3"><i class="fas fa-save"></i> Guardar y Notificar</button>
                    </form>

                    <h6 class="section-title">Bit√°cora de Eventos (Simulado)</h6>
                    <ul id="bitacoraList" class="list-group">
                        <li class="list-group-item list-group-item-secondary">
                            [2025-11-01 10:30] **Creado**. Solicitud iniciada.
                        </li>
                        <li class="list-group-item list-group-item-light">
                            [2025-11-02 14:15] **En Revisi√≥n Legal**. Documentos recibidos y asignados a Mar√≠a L√≥pez.
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // üóÑÔ∏è DATOS QUEMADOS (Se debe mantener el mismo MOCK_SOLICITUDES del dashboard)
        const MOCK_SOLICITUDES_DETALLE = [
            { 
                idTramite: '2025-101', nit: '900123456', entidad: 'Banco Soluci√≥n R√°pida', 
                tipo: 'Establecimientos bancarios', fechaSolicitud: '2025-11-01', 
                responsable: 'Juan P√©rez', area: 'T√©cnico', estadoId: 1, 
                estadoNombre: 'Pendiente de Revisi√≥n', estadoClase: 'pendiente',
                // Datos extendidos para el detalle
                direccion: 'Calle 100 # 10-50, Bogot√°', telefono: '601-555-1234',
                capital: '12.500.000.000', valorPagado: '1.250.000',
                docs: [
                    { nombre: 'C√°mara de Comercio (PDF)', url: '#' },
                    { nombre: 'Soporte de Capital (ZIP)', url: '#' },
                    { nombre: 'Poder de Representaci√≥n Legal (PDF)', url: '#' }
                ]
            },
            { 
                idTramite: '2025-102', nit: '800987654', entidad: 'Corporaci√≥n de Inversi√≥n F√©nix', 
                tipo: 'Corporaciones Financieras', fechaSolicitud: '2025-11-02', 
                responsable: 'Mar√≠a L√≥pez', area: 'Legal', estadoId: 2, 
                estadoNombre: 'En Revisi√≥n Legal', estadoClase: 'revision',
                direccion: 'Carrera 7 # 70-10, Medell√≠n', telefono: '604-444-5678',
                capital: '5.000.000.000', valorPagado: '500.000',
                docs: [
                    { nombre: 'Constituci√≥n Legal (PDF)', url: '#' },
                    { nombre: 'Viabilidad T√©cnica (PDF)', url: '#' }
                ]
            },
            // ... (Otros objetos de solicitud deber√≠an ir aqu√≠)
        ];
        // üö® NOTA: Se recomienda copiar y pegar el MOCK_SOLICITUDES completo de dashboard.html aqu√≠,
        // y solo modificarlo para a√±adir los campos detallados (direccion, capital, docs, etc.)


        // 1. ‚öôÔ∏è Obtener ID del URL
        function getTramiteIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        // 2. üìù Funci√≥n para renderizar los datos
        function renderizarDetalle(solicitud) {
            document.getElementById('tramiteIdDisplay').textContent = solicitud.idTramite;
            document.getElementById('entidadNombreDisplay').textContent = solicitud.entidad;
            
            const estadoBadge = document.getElementById('estadoActualDisplay');
            estadoBadge.textContent = solicitud.estadoNombre;
            estadoBadge.className = `ms-3 status-badge status-${solicitud.estadoClase}`;

            // Llenar Datos Generales
            const datosGenerales = document.getElementById('datosGenerales');
            datosGenerales.innerHTML = `
                <div class="col-md-12"><h6 class="section-title">Informaci√≥n de la Entidad</h6></div>
                <div class="col-md-6"><strong>Tipo de Entidad:</strong> ${solicitud.tipo}</div>
                <div class="col-md-6"><strong>NIT:</strong> ${solicitud.nit}</div>
                <div class="col-md-12"><strong>Direcci√≥n Principal:</strong> ${solicitud.direccion}</div>
                <div class="col-md-6"><strong>Tel√©fono:</strong> ${solicitud.telefono}</div>
                <div class="col-md-6"><strong>Fecha Solicitud:</strong> ${solicitud.fechaSolicitud}</div>
                
                <div class="col-md-12"><h6 class="section-title">Datos Financieros Clave</h6></div>
                <div class="col-md-6"><strong>Capital Suscrito:</strong> $ ${solicitud.capital.toLocaleString('es-CO')}</div>
                <div class="col-md-6"><strong>Valor Pagado:</strong> $ ${solicitud.valorPagado.toLocaleString('es-CO')}</div>
                
                <div class="col-md-12"><h6 class="section-title">Contacto Interno y √Årea Responsable</h6></div>
                <div class="col-md-6"><strong>Responsable Asignado:</strong> ${solicitud.responsable}</div>
                <div class="col-md-6"><strong>√Årea Asignada:</strong> ${solicitud.area}</div>
            `;
            
            // Llenar Documentos
            const documentosList = document.getElementById('documentosList');
            documentosList.innerHTML = solicitud.docs.map(doc => `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    ${doc.nombre}
                    <a href="${doc.url}" class="btn btn-sm btn-outline-primary" target="_blank"><i class="fas fa-download"></i> Descargar</a>
                </li>
            `).join('');
        }

        // 3. üèÅ Inicializaci√≥n de la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            const tramiteId = getTramiteIdFromUrl();
            if (!tramiteId) {
                Swal.fire('Error', 'No se ha especificado el ID del tr√°mite en la URL.', 'error');
                return;
            }

            // Simular b√∫squeda en la API por ID
            const solicitud = MOCK_SOLICITUDES_DETALLE.find(s => s.idTramite === tramiteId);

            if (solicitud) {
                renderizarDetalle(solicitud);
            } else {
                Swal.fire('Error', `Tr√°mite con ID ${tramiteId} no encontrado.`, 'error');
            }
        });

        // 4. üíæ Funci√≥n de Gesti√≥n de Estado (reutilizada del dashboard, adaptada)
        document.getElementById('formGestionEstado').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const nuevoEstado = document.getElementById('nuevoEstado').value;
            const observaciones = document.getElementById('observaciones').value.trim();
            const idTramite = document.getElementById('tramiteIdDisplay').textContent;
            
            if (!nuevoEstado || !observaciones) {
                Swal.fire('Atenci√≥n', 'Debe seleccionar un nuevo estado y registrar observaciones.', 'warning');
                return;
            }

            Swal.fire({
                title: 'Confirmar Actualizaci√≥n',
                text: "¬øEst√° seguro de cambiar el estado de la solicitud?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#007bff',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'S√≠, Actualizar'
            }).then((result) => {
                if (result.isConfirmed) {
                    simularActualizacion(idTramite, nuevoEstado, observaciones);
                }
            });
        });

        // 5. Funci√≥n para simular la actualizaci√≥n (solo visual)
        function simularActualizacion(idTramite, nuevoEstadoId, observaciones) {
             Swal.fire({
                title: "Simulando Actualizaci√≥n...",
                text: "Llamando al endpoint de Azure Function...",
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading(),
            });
            
            setTimeout(() => {
                const estadoMap = {
                    "1": { nombre: 'Pendiente de Revisi√≥n', clase: 'pendiente' },
                    "2": { nombre: 'En Revisi√≥n Legal', clase: 'revision' },
                    "3": { nombre: 'Aprobado', clase: 'aprobado' },
                    "4": { nombre: 'Rechazado', clase: 'rechazado' },
                };

                const nuevoEstado = estadoMap[nuevoEstadoId];
                
                // Actualizar el estado visual en la p√°gina de detalle
                document.getElementById('estadoActualDisplay').textContent = nuevoEstado.nombre;
                document.getElementById('estadoActualDisplay').className = `ms-3 status-badge status-${nuevoEstado.clase}`;
                
                // A√±adir el nuevo evento a la Bit√°cora (simulado)
                const bitacora = document.getElementById('bitacoraList');
                const now = new Date();
                const nowString = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                
                const newLog = document.createElement('li');
                newLog.className = 'list-group-item list-group-item-success';
                newLog.innerHTML = `[${nowString}] **${nuevoEstado.nombre}**. ${observaciones} (Actualizado por Funcionario)`;
                bitacora.appendChild(newLog);

                Swal.fire("√âxito (Simulado)", `El estado de la solicitud ${idTramite} ha sido actualizado a: ${nuevoEstado.nombre}.`, "success");
            }, 1500);
        }
    </script>
</body>
</html>