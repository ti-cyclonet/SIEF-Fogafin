<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Formulario de Inscripción</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.0/dist/sweetalert2.min.css"
    />
    <link rel="stylesheet" href="../assets/css/styles.css" />
    <style>
      input[type="file"] {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
      }
      
      .file-wrapper {
        display: flex;
        align-items: center;
        justify-content: space-between;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 0.375rem 0.75rem;
        background-color: #fff;
        cursor: pointer;
        min-height: 38px;
      }
      
      .file-wrapper:hover {
        border-color: #86b7fe;
      }
    </style>
  </head>
  <body>
    <div id="header"></div>

    <div class="container mt-4 mb-5">
      <h2 class="mb-3 text-center">
        Formulario de Inscripción al Fondo de Garantías de Instituciones
        Financieras
      </h2>

      <p class="text-end">
        <a href="../assets/documents/InscripcindetercerosV_11.3.xlsx" download>
          Descargar formato inscripción terceros
        </a>
      </p>

      <form id="inscripcionForm" class="needs-validation" novalidate>
        <!-- DATOS DE LA ENTIDAD -->
        <h5 class="section-title">Datos de la Entidad</h5>
        <div class="row g-3 align-items-center">
          <div class="col-md-4">
            <label class="col-form-label">Razón social*</label>
          </div>
          <div class="col-md-8">
            <input id="razonSocial" type="text" class="form-control" required />
          </div>

          <div class="col-md-4"><label class="col-form-label">Nit*</label></div>
          <div class="col-md-8">
            <input id="nit" type="number" class="form-control" required />
          </div>

          <div class="col-md-4">
            <label class="col-form-label">Tipo de entidad*</label>
          </div>
          <div class="col-md-8">
            <select id="tipoEntidad" class="form-select" required>
              <option value="">Seleccione...</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="col-form-label">Fecha resolución constitución*</label>
          </div>
          <div class="col-md-8">
            <input
              id="fechaConstitucion"
              type="date"
              class="form-control"
              required
            />
          </div>

          <div class="col-md-4">
            <label class="col-form-label">Capital suscrito*</label>
          </div>
          <div class="col-md-8">
            <input
              id="capitalSuscrito"
              type="text"
              class="form-control"
              min="0"
              step="0.01"
              required
              placeholder="$0.000.000,00"
              style="text-align: right"
              autocomplete="off"
            />
          </div>

          <div class="col-md-4">
            <label class="col-form-label">Logo de la entidad</label>
          </div>
          <div class="col-md-8">
            <div class="file-wrapper" id="logoEntidadWrapper">
              <span class="text-muted flex-grow-1" id="logoEntidadText">Ningún archivo seleccionado</span>
              <span class="badge bg-light text-dark">Seleccionar archivo</span>
              <input id="logoEntidad" type="file" accept=".tiff,.jpg,.jpeg,.bmp,.gif,.png" />
            </div>
            <div class="form-text">
              Formatos: .tiff, .jpg, .jpeg, .bmp, .gif, .png
            </div>
          </div>

          <div class="col-md-4">
            <label class="col-form-label">Página web</label>
          </div>
          <div class="col-md-8">
            <input id="paginaWeb" type="url" class="form-control" />
          </div>

          <div class="col-md-4">
            <label class="col-form-label">Correo de notificación*</label>
          </div>
          <div class="col-md-8">
            <input id="correoNoti" type="email" class="form-control" required />
          </div>

          <div class="col-md-4">
            <label class="col-form-label"
              >Resolución de autorización (PDF)*</label
            >
          </div>
          <div class="col-md-8">
            <div class="file-wrapper" id="resolucionWrapper">
              <span class="text-muted flex-grow-1" id="resolucionText">Ningún archivo seleccionado</span>
              <span class="badge bg-light text-dark">Seleccionar archivo</span>
              <input id="resolucion" type="file" accept=".pdf" required />
            </div>
          </div>

          <div class="col-md-4">
            <label class="col-form-label"
              >Formato de inscripción a terceros (PDF)*</label
            >
          </div>
          <div class="col-md-8">
            <div class="file-wrapper" id="formatoTercerosWrapper">
              <span class="text-muted flex-grow-1" id="formatoTercerosText">Ningún archivo seleccionado</span>
              <span class="badge bg-light text-dark">Seleccionar archivo</span>
              <input id="formatoTerceros" type="file" accept=".pdf" required />
            </div>
          </div>
        </div>

        <!-- PAGO -->
        <h5 class="section-title">Información del pago de la inscripción</h5>
        <div class="row g-3 align-items-center">
          <div class="col-md-4">
            <label class="col-form-label">Valor pagado*</label>
          </div>
          <div class="col-md-8">
            <input
              id="valorPagado"
              type="text"
              class="form-control"
              min="0"
              step="0.01"
              required
              placeholder="$0.000.000,00"
              style="text-align: right"
              autocomplete="off"
            />
          </div>

          <div class="col-md-4">
            <label class="col-form-label">Fecha de pago*</label>
          </div>
          <div class="col-md-8">
            <input id="fechaPago" type="date" class="form-control" required />
          </div>

          <div class="col-md-4">
            <label class="col-form-label">Soporte de pago (PDF)*</label>
          </div>
          <div class="col-md-8">
            <div class="file-wrapper" id="soportePagoWrapper">
              <span class="text-muted flex-grow-1" id="soportePagoText">Ningún archivo seleccionado</span>
              <span class="badge bg-light text-dark">Seleccionar archivo</span>
              <input id="soportePago" type="file" accept=".pdf" required />
            </div>
          </div>
        </div>

        <!-- REPRESENTANTE -->
        <h5 class="section-title">Representante legal o apoderado</h5>
        <div class="row g-3 align-items-center">
          <div class="col-md-4">
            <label class="col-form-label">Nombre(s)*</label>
          </div>
          <div class="col-md-8">
            <input
              id="nombreRepresentante"
              type="text"
              class="form-control"
              required
            />
          </div>

          <div class="col-md-4">
            <label class="col-form-label">Apellido(s)*</label>
          </div>
          <div class="col-md-8">
            <input
              id="apellidoRepresentante"
              type="text"
              class="form-control"
              required
            />
          </div>

          <div class="col-md-4">
            <label class="col-form-label">Cargo*</label>
          </div>
          <div class="col-md-8">
            <select id="cargoRepresentante" class="form-select" required>
              <option value="">Seleccione...</option>
              <option value="Representante legal">Representante legal</option>
              <option value="Apoderado">Apoderado</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="col-form-label">Tipo de identificación*</label>
          </div>
          <div class="col-md-8">
            <select id="tipoIdentificacion" class="form-select" required>
              <option value="">Seleccione...</option>
              <option value="1">Cédula de ciudadanía</option>
              <option value="2">Cédula de extranjería</option>
              <option value="5">Pasaporte</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="col-form-label">Número de documento*</label>
          </div>
          <div class="col-md-8">
            <input
              id="numeroDocumento"
              type="text"
              class="form-control"
              required
            />
          </div>

          <div class="col-md-4">
            <label class="col-form-label">Correo electrónico*</label>
          </div>
          <div class="col-md-8">
            <input
              id="correoRepresentante"
              type="email"
              class="form-control"
              required
            />
          </div>

          <div class="col-md-4">
            <label class="col-form-label">Teléfono*</label>
          </div>
          <div class="col-md-8">
            <input
              id="telefonoRep"
              type="number"
              class="form-control"
              required
            />
          </div>

          <div class="col-md-4">
            <label class="col-form-label"
              >Certificado de existencia (PDF)*</label
            >
          </div>
          <div class="col-md-8">
            <div class="file-wrapper" id="certificadoExistenciaWrapper">
              <span class="text-muted flex-grow-1" id="certificadoExistenciaText">Ningún archivo seleccionado</span>
              <span class="badge bg-light text-dark">Seleccionar archivo</span>
              <input id="certificadoExistencia" type="file" accept=".pdf" required />
            </div>
          </div>
        </div>

        <!-- RESPONSABLE -->
        <h5 class="section-title">Responsable del registro</h5>
        <div class="row g-3 align-items-center">
          <div class="col-md-4">
            <label class="col-form-label">Nombre(s) y Apellido(s)*</label>
          </div>
          <div class="col-md-8">
            <input
              id="nombreResponsable"
              type="text"
              class="form-control"
              required
            />
          </div>

          <div class="col-md-4">
            <label class="col-form-label">Correo electrónico*</label>
          </div>
          <div class="col-md-8">
            <input
              id="correoResponsable"
              type="email"
              class="form-control"
              required
            />
          </div>

          <div class="col-md-4">
            <label class="col-form-label">Teléfono*</label>
          </div>
          <div class="col-md-8">
            <input
              id="telefonoResponsable"
              type="number"
              class="form-control"
              required
            />
          </div>
        </div>

        <div class="text-center mt-4">
          <button type="submit" class="btn btn-primary">
            Enviar solicitud
          </button>
          <a href="../index.html" class="btn btn-secondary">Volver</a>
          <button type="button" id="btnConsultar" class="btn btn-success">
            Consultar
          </button>
        </div>
      </form>
    </div>

    <div id="footer"></div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../config.js"></script>

    <script>
      const URL_REGISTRAR = getApiUrl("RegistrarEntidad");
      const URL_SUBIR = getApiUrl("SubirArchivo");
      const URL_CONSULTAR_NIT = (nit) => getApiUrl(`ConsultarNIT/${nit}`);
      const URL_SECTORES = (codigos) => getApiUrl(`ConsultarSectores/${codigos}`);

      const form = document.getElementById("inscripcionForm");
      
      const fileValidations = {
        'logoEntidad': ['.tiff', '.jpg', '.jpeg', '.bmp', '.gif', '.png'],
        'resolucion': ['.pdf'],
        'formatoTerceros': ['.pdf'],
        'soportePago': ['.pdf'],
        'certificadoExistencia': ['.pdf']
      };
      
      function validateFile(fieldId, file) {
        if (!file) return { valid: true };
        const fileName = file.name.toLowerCase();
        const allowedExtensions = fileValidations[fieldId] || [];
        const isValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));
        return {
          valid: isValidExtension,
          message: isValidExtension ? '' : `Solo se permiten archivos con extensiones ${allowedExtensions.join(', ')}`
        };
      }
      
      function showFileError(fieldId, message) {
        const wrapper = document.getElementById(fieldId + 'Wrapper');
        const container = wrapper.closest('.col-md-8');
        const existingError = container.querySelector('.file-error');
        if (existingError) existingError.remove();
        if (wrapper) {
          wrapper.style.setProperty('border', '1px solid #dc3545', 'important');
          wrapper.style.setProperty('border-color', '#dc3545', 'important');
        }
        const errorDiv = document.createElement('div');
        errorDiv.className = 'file-error';
        errorDiv.style.color = '#dc3545';
        errorDiv.style.fontSize = '0.875rem';
        errorDiv.style.marginTop = '0.5rem';
        errorDiv.style.display = 'block';
        errorDiv.textContent = message;
        container.appendChild(errorDiv);
      }
      
      function clearFileError(fieldId) {
        const wrapper = document.getElementById(fieldId + 'Wrapper');
        const container = wrapper.closest('.col-md-8');
        const existingError = container.querySelector('.file-error');
        if (existingError) existingError.remove();
        if (wrapper) {
          wrapper.style.removeProperty('border');
          wrapper.style.removeProperty('border-color');
        }
      }

      function formatearMoneda(valor) {
        return "$ " + Number(valor).toLocaleString("es-CO", {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        });
      }
      
      function formatearMonedaConDecimales(valor) {
        return "$ " + Number(valor).toLocaleString("es-CO", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      }

      function limpiarFormato(valor, permitirDecimales = false) {
        if (!valor) return 0;
        if (permitirDecimales) {
          return parseFloat(valor.replace(/[^\d.]/g, "")) || 0;
        } else {
          return Number(valor.replace(/[^\d]/g, "")) || 0;
        }
      }

      function aplicarFormatoCampo(input, permitirDecimales = false) {
        input.addEventListener("input", (e) => {
          if (document.activeElement === input) {
            if (permitirDecimales) {
              let valor = e.target.value.replace(/[^0-9.]/g, "");
              const puntos = valor.split('.');
              if (puntos.length > 2) {
                valor = puntos[0] + '.' + puntos.slice(1).join('');
              }
              e.target.value = valor;
            } else {
              e.target.value = e.target.value.replace(/[^0-9]/g, "");
            }
          }
        });
        
        input.addEventListener("focus", () => {
          const valorGuardado = input.dataset.valor || "";
          if (permitirDecimales) {
            input.value = valorGuardado ? parseFloat(valorGuardado) : "";
          } else {
            input.value = valorGuardado ? parseInt(valorGuardado) : "";
          }
        });

        input.addEventListener("blur", () => {
          const valor = limpiarFormato(input.value, permitirDecimales);
          if (valor > 0) {
            input.dataset.valor = valor;
            if (permitirDecimales) {
              input.value = formatearMonedaConDecimales(valor);
            } else {
              input.value = formatearMoneda(valor);
            }
          } else {
            input.dataset.valor = "";
            input.value = "";
          }
        });
      }

      const capitalSuscritoInput = document.getElementById("capitalSuscrito");
      const valorPagadoInput = document.getElementById("valorPagado");

      aplicarFormatoCampo(capitalSuscritoInput, true);
      aplicarFormatoCampo(valorPagadoInput, true);
      
      // Configurar file inputs con wrapper
      const fileInputs = ['logoEntidad', 'resolucion', 'formatoTerceros', 'soportePago', 'certificadoExistencia'];
      fileInputs.forEach(id => {
        const fileInput = document.getElementById(id);
        const wrapper = document.getElementById(id + 'Wrapper');
        const textSpan = document.getElementById(id + 'Text');
        
        if (wrapper) {
          wrapper.addEventListener('click', () => fileInput.click());
          fileInput.addEventListener('change', () => {
            clearFileError(id);
            if (fileInput.files && fileInput.files.length > 0) {
              const file = fileInput.files[0];
              const validation = validateFile(id, file);
              if (!validation.valid) {
                showFileError(id, validation.message);
              }
              textSpan.textContent = file.name;
            } else {
              textSpan.textContent = 'Ningún archivo seleccionado';
            }
          });
        }
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        let hasFileErrors = false;
        
        Object.keys(fileValidations).forEach(fieldId => {
          const fileInput = document.getElementById(fieldId);
          clearFileError(fieldId);
          
          if (fileInput.hasAttribute('required') && (!fileInput.files || fileInput.files.length === 0)) {
            hasFileErrors = true;
            showFileError(fieldId, 'Este campo es obligatorio');
          }
          
          if (fileInput.files && fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const validation = validateFile(fieldId, file);
            if (!validation.valid) {
              hasFileErrors = true;
              showFileError(fieldId, validation.message);
            }
          }
        });
        
        if (hasFileErrors || !form.checkValidity()) {
          form.classList.add("was-validated");
          Swal.fire("", "Por favor complete todos los campos obligatorios y corrija los errores.", "error");
          return;
        }

        const capital = parseFloat(capitalSuscritoInput.dataset.valor) || 0;
        const valorPagado = parseFloat(valorPagadoInput.dataset.valor) || 0;
        const esperado = (capital * 0.115) / 1000;
        const diferencia = Math.abs(valorPagado - esperado);

        if (diferencia > 0.00001) {
          Swal.fire("", "Recuerde que el valor pagado por inscripción debe ser 0.115 por mil del capital suscrito. Por favor, valide la información ingresada.", "error");
          return;
        }

        Swal.fire({
          title: "Enviando...",
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading(),
        });

        try {
          const nit = document.getElementById("nit").value;
          const fileInputs = ["logoEntidad", "resolucion", "formatoTerceros", "soportePago", "certificadoExistencia"];

          for (const id of fileInputs) {
            const file = document.getElementById(id).files[0];
            if (file) {
              const fileName = file.name.toLowerCase();
              const allowedExtensions = fileValidations[id] || [];
              const isValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));
              if (!isValidExtension) {
                throw new Error(`El archivo "${file.name}" no tiene una extensión válida. Solo se permiten: ${allowedExtensions.join(', ')}`);
              }
            }
          }
          
          const uploadPromises = fileInputs.map(async (id) => {
            const file = document.getElementById(id).files[0];
            if (!file) return { id, url: null };

            const reader = new FileReader();
            const fileBase64 = await new Promise((resolve, reject) => {
              reader.onload = () => resolve(reader.result.split(",")[1]);
              reader.onerror = reject;
              reader.readAsDataURL(file);
            });

            const prefijos = {
              'logoEntidad': 'LOGO_',
              'resolucion': 'RESOLUCION_',
              'formatoTerceros': 'TERCEROS_',
              'soportePago': 'PAGO_',
              'certificadoExistencia': 'CERTIFICADO_'
            };
            
            const prefijo = prefijos[id] || '';
            const nombreConPrefijo = prefijo + file.name;

            const payload = {
              nit,
              archivoBase64: fileBase64,
              nombreArchivo: nombreConPrefijo,
              contentType: file.type,
            };

            const resp = await fetch(URL_SUBIR, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            const respText = await resp.text();
            if (resp.status === 409) throw new Error(respText);
            if (!resp.ok) throw new Error(`Error al subir ${id}: ${respText}`);

            return { id, url: respText };
          });

          const uploadedArray = await Promise.all(uploadPromises);
          const uploaded = Object.fromEntries(uploadedArray.map((u) => [u.id, u.url]));

          const archivosAdjuntos = [];
          Object.keys(uploaded).forEach(key => {
            if (uploaded[key]) {
              archivosAdjuntos.push(uploaded[key]);
            }
          });

          const correosConfirmacion = [
            document.getElementById("correoNoti").value,
            document.getElementById("correoRepresentante").value,
            document.getElementById("correoResponsable").value
          ].filter(correo => correo && correo.trim() !== "");

          const data = {
            TipoEntidad: parseInt(document.getElementById("tipoEntidad").value),
            Nombre: document.getElementById("razonSocial").value,
            Nit: nit,
            CorreoNoti: document.getElementById("correoNoti").value,
            IdentificacionRep: document.getElementById("numeroDocumento").value,
            TipoDoc: document.getElementById("tipoIdentificacion").value,
            NombreRep: document.getElementById("nombreRepresentante").value,
            ApellidoRep: document.getElementById("apellidoRepresentante").value,
            CargoRep: document.getElementById("cargoRepresentante").value,
            CorreoRep: document.getElementById("correoRepresentante").value,
            TelefonoRep: document.getElementById("telefonoRep").value,
            CartaSolicitud: uploaded["formatoTerceros"] || null,
            CertificadoSuper: uploaded["resolucion"] || null,
            NombreResponsable: document.getElementById("nombreResponsable").value,
            CorreoResponsable: document.getElementById("correoResponsable").value,
            TelefonoResponsable: document.getElementById("telefonoResponsable").value,
            FechaConstitucion: new Date(document.getElementById("fechaConstitucion").value).toISOString(),
            CapitalSuscrito: capital,
            ValorPagado: valorPagado,
            RutaComprobantePago: uploaded["soportePago"] || null,
            FechaPago: new Date(document.getElementById("fechaPago").value).toISOString(),
            PaginaWeb: document.getElementById("paginaWeb").value || null,
            RutaLogoEntidad: uploaded["logoEntidad"] || null,
            Fecha: new Date().toISOString(),
            ArchivosAdjuntos: archivosAdjuntos,
            CorreosConfirmacion: correosConfirmacion,
          };

          const response = await fetch(URL_REGISTRAR, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          if (!response.ok) {
            const errorText = await response.text();
            Swal.fire("Error", errorText, "error");
            return;
          }

          const result = await response.json();
          const numeroTramite = `${result.TM08_Consecutivo}${result.TM08_TM01_Codigo}${result.TM08_Ano}`;
          const responsable = result.TM03_Nombre;
          const siglas = result.Departamento;

          Swal.fire({
            icon: "success",
            title: "Inscripción registrada",
            html: `<p style="text-align: center;">Su solicitud de inscripción fue recibida para la validación de documentos. El número de trámite asignado es <strong>${numeroTramite}</strong> y fue asignada a <strong>${responsable}</strong> del departamento <b>${siglas}</b>. El tiempo estimado de respuesta es de tres días hábiles.</p><p style="text-align: center;">A su correo electrónico se enviará información adicional.</p>`,
            confirmButtonText: "Cerrar",
          }).then(() => {
            form.reset();
            form.classList.remove("was-validated");
          });
        } catch (err) {
          Swal.fire("Error", err.message, "error");
        }
      });

      async function cargarTiposEntidad(codigosDeseados) {
        const tipoEntidadSelect = document.getElementById("tipoEntidad");
        tipoEntidadSelect.innerHTML = '<option value="">Seleccione...</option>';
        try {
          const response = await fetch(URL_SECTORES(codigosDeseados.join(",")));
          if (!response.ok) throw new Error("Error al obtener los sectores financieros");
          const sectores = await response.json();
          sectores.forEach((sector) => {
            const option = document.createElement("option");
            option.value = sector.TM01_CODIGO;
            option.textContent = sector.TM01_NOMBRE;
            tipoEntidadSelect.appendChild(option);
          });
        } catch (error) {
          console.error("Fallo al cargar los tipos de entidad:", error);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        cargarTiposEntidad([1, 2, 4, 28]);
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('fechaConstitucion').max = today;
        document.getElementById('fechaPago').max = today;
      });

      const btnConsultar = document.getElementById("btnConsultar");
      if (btnConsultar) {
        btnConsultar.addEventListener("click", async () => {
          const nit = document.getElementById("nit").value.trim();
          if (!nit) {
            Swal.fire("Atención", "Por favor ingrese el NIT para consultar.", "warning");
            return;
          }

          try {
            Swal.fire({
              title: "Consultando NIT...",
              allowOutsideClick: false,
              didOpen: () => Swal.showLoading(),
            });

            const response = await fetch(URL_CONSULTAR_NIT(nit));
            const data = await response.json();
            Swal.close();

            if (!response.ok) {
              throw new Error("Error en la consulta del NIT.");
            }

            if (data.existe === true) {
              if (data.entidad) {
                document.getElementById('nombreResponsable').value = data.entidad.TM02_NombreResponsable || '';
                document.getElementById('correoResponsable').value = data.entidad.TM02_CorreoResponsable || '';
                document.getElementById('telefonoResponsable').value = data.entidad.TM02_TelefonoResponsable || '';
              }
              Swal.fire({
                icon: "info",
                title: "Entidad registrada",
                html: `<p>Ya se encuentra registrada en nuestro sistema una entidad con el NIT proporcionado.</p><p>Se han cargado los datos del responsable registrado.</p>`,
                confirmButtonText: "Cerrar",
              });
            } else {
              Swal.fire({
                icon: "success",
                title: "NIT no encontrado",
                html: `<p>NIT no encontrado. Puede continuar con el registro de la entidad financiera.</p>`,
                confirmButtonText: "Continuar",
              });
            }
          } catch (error) {
            Swal.close();
            Swal.fire("Error", error.message, "error");
          }
        });
      }
    </script>


  </body>
</html>















